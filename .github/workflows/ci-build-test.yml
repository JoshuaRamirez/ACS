# ==============================================================================
# GitHub Actions CI Pipeline for ACS
# Handles build, test, security scanning, and quality checks
# ==============================================================================
name: CI - Build and Test

on:
  push:
    branches: [ main, develop, 'release/*', 'feature/*' ]
  pull_request:
    branches: [ main, develop ]
    
env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  REGISTRY: ghcr.io
  IMAGE_PREFIX: acs

jobs:
  # Build and Test Job
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            artifact-name: linux-artifacts
          - os: windows-latest
            artifact-name: windows-artifacts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for GitVersion
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
            
      - name: Restore dependencies
        run: dotnet restore ACS.sln
        
      - name: Build solution
        run: dotnet build ACS.sln --configuration Release --no-restore
        
      - name: Run unit tests
        run: |
          dotnet test ACS.Service.Tests.Unit/ACS.Service.Tests.Unit.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger trx
            
      - name: Run infrastructure tests
        run: |
          dotnet test ACS.Infrastructure.Tests/ACS.Infrastructure.Tests.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger trx
            
      - name: Run VerticalHost tests
        run: |
          dotnet test ACS.VerticalHost.Tests/ACS.VerticalHost.Tests.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger trx
            
      - name: Generate test report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results (${{ matrix.os }})
          path: TestResults/*.trx
          reporter: dotnet-trx
          
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.artifact-name }}
          path: |
            TestResults/
            **/*.trx
            **/*.xml
            
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.artifact-name }}
          path: |
            **/bin/Release/**
            **/obj/Release/**
            !**/bin/Release/**/ref/**
            !**/bin/Release/**/refs/**

  # Code Quality and Security Analysis
  code-analysis:
    name: Code Analysis and Security
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Restore dependencies
        run: dotnet restore ACS.sln
        
      - name: Run CodeQL analysis
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          
      - name: Build for CodeQL
        run: dotnet build ACS.sln --configuration Release
        
      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        
      - name: Run security audit
        run: dotnet list package --vulnerable --include-transitive
        
      - name: Install security scanner
        run: dotnet tool install --global security-scan
        
      - name: Run security scan
        run: security-scan ACS.sln --excl-proj=**Tests**
        
      - name: SonarCloud scan
        if: env.SONAR_TOKEN != null
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          
  # Integration Tests (requires Docker)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test123
          POSTGRES_USER: testuser
          POSTGRES_DB: acs_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Restore dependencies
        run: dotnet restore ACS.sln
        
      - name: Build solution
        run: dotnet build ACS.sln --configuration Release --no-restore
        
      - name: Run integration tests
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost;Database=acs_test;User Id=testuser;Password=test123;"
          ConnectionStrings__Redis: "localhost:6379"
        run: |
          dotnet test ACS.WebApi.Tests.Integration/ACS.WebApi.Tests.Integration.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./IntegrationTestResults \
            --logger trx
            
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: IntegrationTestResults/
          
  # Performance Tests
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Restore dependencies
        run: dotnet restore ACS.sln
        
      - name: Build solution
        run: dotnet build ACS.sln --configuration Release --no-restore
        
      - name: Run performance tests
        run: |
          dotnet test ACS.WebApi.Tests.Performance/ACS.WebApi.Tests.Performance.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger trx
            
      - name: Upload performance test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: |
            **/*perf*.trx
            **/*benchmark*
            **/*performance*