# ==============================================================================
# Kustomization Base Configuration for ACS
# ==============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: acs-base
  annotations:
    config.kubernetes.io/local-config: "true"

# Base resources
resources:
  - namespace.yaml
  - webapi-deployment.yaml
  - verticalhost-deployment.yaml
  - services.yaml
  - configmaps.yaml
  - secrets.yaml
  - storage.yaml
  - autoscaling.yaml

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/name: acs
  app.kubernetes.io/component: access-control-system
  app.kubernetes.io/managed-by: kustomize

# Common annotations
commonAnnotations:
  config.kubernetes.io/origin: |
    path: Infrastructure/Kubernetes/base
    repo: https://github.com/your-org/acs

# Image transformations
images:
  - name: ghcr.io/your-org/acs-webapi
    newTag: latest
  - name: ghcr.io/your-org/acs-verticalhost
    newTag: latest

# Config generation
configMapGenerator:
  - name: acs-build-info
    literals:
      - BUILD_DATE=2025-01-06
      - BUILD_VERSION=1.0.0
      - GIT_COMMIT=unknown

# Secret generation (for development only)
secretGenerator:
  - name: acs-dev-secrets
    literals:
      - jwt-secret-key=dev-jwt-secret-key-change-in-production
      - redis-password=dev-redis-password
    type: Opaque

# Patches
patches:
  # Add resource quotas to all containers
  - target:
      kind: Deployment
      name: ".*"
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/resources/limits/ephemeral-storage
        value: "2Gi"
      - op: add
        path: /spec/template/spec/containers/0/resources/requests/ephemeral-storage
        value: "1Gi"

# Replacements for template variables (handled by overlays)
replacements:
  - source:
      kind: ConfigMap
      name: acs-config
      fieldPath: data.environment
    targets:
      - select:
          kind: Deployment
        fieldPaths:
          - spec.template.spec.containers.[name=webapi].env.[name=ASPNETCORE_ENVIRONMENT].value
          - spec.template.spec.containers.[name=verticalhost].env.[name=ASPNETCORE_ENVIRONMENT].value